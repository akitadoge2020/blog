# 跨标签页通信

顾名思义，就是一个标签页发送消息给另一个标签页。

实现跨标签页通信的方式有以下几种：

- BroadcastChannel
- Service Worker
- LocalStorage window.onstorage监听
- Shared Worker 定时器轮询（setInterval）
- IndexDB 定时器轮询（setInterval）
- cookie 定时器轮询（setInterval）
- window.open window.postMessage
- Websocket

## BroadcastChannel

BroadcastChannel可以帮我们创建一个用于广播的通信频道。当所有页面都监听同一频道的信息时，其中某一个页面通过它发送的消息就会被其他所有页面监听到，但前提是同源页面。

```html
<!-- index1.html -->
<html>
	<head>
		<title>页面1</title>
	</head>
	<body>
		<input type="text" id="ipt">
		<button id="btn">发送数据</button>
		<script>
        	const ipt = document.querySelector("#ipt");
            const btn = document.querySelector("#btn");
            // 创建一个名字叫load1的BroadcastChannel实例
            const bc = new BroadcastChannel('load1');
            btn.onclick = function () {
                bc.postMessage({
                    value: ipt.value
                });
            }
        </script>
	</body>
</html>
```

```html
<!-- index2.html -->
<html>
	<head>
		<title>页面2</title>
	</head>
	<body>
		<script>
            // 创建一个名字叫load1的BroadcastChannel实例
            const bc = new BroadcastChannel('load1');
            bc.onmessage = function (e) {
                console.log(e.data);
            }
        </script>
	</body>
</html>
```

## Service Worker

Service Worker实际上是浏览器和服务器之间的代理服务器，它最大的特点是在页面中注册并安装成功后，运行于浏览器后台，不受页面刷新的影响，可以监听和拦截作用域范围内的所有页面的HTTP请求。

Service Worker的目的在于离线缓存，转发请求和网络代理。

在已经支持Service Worker的浏览器的版本中，很多特性没有默认开启。如果你发现示例代码在当前版本的浏览器中怎么样都无法正常运行，你可能需要开启一下浏览器的相关配置：

- Firefox Nightly: 访问 about:config 并设置 dom.serviceWorkers.enabled 的值为 true; 重启浏览器；
- Chrome Canary: 访问 chrome://flags 并开启 experimental-web-platform-features; 重启浏览器 (注意：有些特性在Chrome中没有默认开放支持)；
- Opera: 访问 opera://flags 并开启 ServiceWorker 的支持; 重启浏览器。 

```html
<!-- index1.html -->
<html>
	<head>
		<title>页面1</title>
	</head>
	<body>
        <input type="text" id="ipt">
		<button id="btn">发送数据</button>
		<script>
            const ipt = document.querySelector("#ipt");
            const btn = document.querySelector("#btn");
			window.navigator.serviceWorker.register('sw.js').then(() => {
                console.log('service worker注册成功');
            })			
            btn.onclick = function () {
                window.navigator.serviceWorker.controller.postMessage({
                    value: ipt.value
                });
            }
        </script>
	</body>
</html>
```

```js
// sw.js
// 消息会到达这里

self.addEventListener("message", async event => {
    // 首先获取所有注册了service worker的客户端
    const clients = await self.clients.matchAll();
    // 然后遍历所有客户端，将消息转发出去
    clients.forEach(client => {
        client.postMessage(event.data);
    })
})
```

```html
<!-- index2.html -->
<html>
	<head>
		<title>页面2</title>
	</head>
	<body>
		<script>
			window.navigator.serviceWorker.register('sw.js').then(() => {
                console.log('service worker注册成功');
            })	
            window.navigator.serviceWorker.onmessage = function (res) {
                console.log(res);
            }
        </script>
	</body>
</html>
```

