# 编译过程

webpack的作用就是将源代码编译（构建、打包）成最终代码。

![image-20220627164436495](https://penguinbucket.obs.cn-southwest-2.myhuaweicloud.com/img/image-20220627164436495.png)

整个过程大致分为三个步骤：

1. 初始化
2. 编译
3. 输出

## 初始化

此阶段，webpack会将**CLI参数**、**配置文件**、**默认配置**进行融合，形成一个最终的配置对象。对配置的处理过程是依托一个第三方库`yargs`完成的。

此阶段相对比较简单，主要是为接下来的编译阶段做必要的准备，我们可以简单的理解为，初始化阶段主要目的是产生一个最终的配置。

## 编译

### 1. 创建chunk

chunk是webpack在内部构建模块过程中的一个概念，译为`块`，它表示通过某个入口找到的所有依赖的统称。

根据入口模块（默认为`./src/index.js`）创建一个chunk。

<img src="https://penguinbucket.obs.cn-southwest-2.myhuaweicloud.com/img/image-20220627164401087.png" alt="image-20220627164401087" style="zoom:67%;" />

每个chunk都有至少两个属性：

- name：默认为main
- id：唯一编号，开发环境和name相同，生产环境是一个数字，从0开始

### 2. 构建所有依赖模块

![image-20220627165922462](https://penguinbucket.obs.cn-southwest-2.myhuaweicloud.com/img/image-20220627165922462.png)

- 从入口模块开始进行构建，根据入口模块的路径找到对应的模块文件
- 检查文件加载记录
  - 如果模块文件已经加载过，则跳过
  - 如果模块文件未加载，则继续
- 读取模块文件的内容，对其进行语法分析，将其转换成AST
- 遍历AST，将模块文件的所有依赖记录到dependencies中
- 将读取到的文件内容中的依赖函数替换成`__webpack_require`（注意！这里不是修改文件内容本身，而是修改读取到的文件内容，本质是一个字符串），我们称这个字符串为转换后的模块代码
- 将转换后的模块代码保存，按照模块id一一映射
- 根据dependencies中的内容递归加载模块

### 3. 生成chunk assets

在第二步完成后，chunk中会产生一个模块列表，列表中包含了**模块id**和**模块转换后的代码**。



### 4. 合并chunk assets

