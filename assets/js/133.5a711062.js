(window.webpackJsonp=window.webpackJsonp||[]).push([[133],{597:function(t,e,s){"use strict";s.r(e);var a=s(17),n=Object(a.a)({},(function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"websocket"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#websocket"}},[t._v("#")]),t._v(" WebSocket")]),t._v(" "),s("h2",{attrs:{id:"实时场景的旧处理方案"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#实时场景的旧处理方案"}},[t._v("#")]),t._v(" 实时场景的旧处理方案")]),t._v(" "),s("p",[t._v("考虑网页中的以下场景：")]),t._v(" "),s("ul",[s("li",[t._v("股票K线图")]),t._v(" "),s("li",[t._v("聊天")]),t._v(" "),s("li",[t._v("警报、重要通知")]),t._v(" "),s("li",[t._v("余座")]),t._v(" "),s("li",[t._v("抢购页面的库存")]),t._v(" "),s("li",[t._v("......")])]),t._v(" "),s("p",[t._v("上述场景有一个共同特点——实时性。")]),t._v(" "),s("p",[t._v("这种对实时性有要求的页面，会带来一些问题，比如下面的聊天场景：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://penguinbucket.obs.cn-southwest-2.myhuaweicloud.com/img/image-20220606164028082.png",alt:"image-20220606164028082"}})]),t._v(" "),s("p",[t._v("由于HTTP协议是请求-响应模式，请求必须在前，响应必须在后，这就导致了服务器无法**「主动」**的把消息告诉客户端。")]),t._v(" "),s("p",[t._v("以前常见的解决方案有两种，短轮询和长轮询。")]),t._v(" "),s("h2",{attrs:{id:"短轮询-short-polling"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#短轮询-short-polling"}},[t._v("#")]),t._v(" 短轮询 short polling")]),t._v(" "),s("p",[t._v("短轮询是一种「话痨式」的方式，客户端每隔一小段时间就向服务器请求一次，询问有没有新消息。")]),t._v(" "),s("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://penguinbucket.obs.cn-southwest-2.myhuaweicloud.com/img/image-20220606164524774.png",alt:"image-20220606164524774"}}),t._v(" "),s("p",[t._v("实现短轮询是非常简单的，客户端只需要设置一个计时器不断发送请求即可。")]),t._v(" "),s("p",[t._v("但这种方案的缺陷是非常明显的：")]),t._v(" "),s("ul",[s("li",[t._v("会产生大量无意义的请求")]),t._v(" "),s("li",[t._v("会频繁打开关闭连接")]),t._v(" "),s("li",[t._v("实时性并不高")])]),t._v(" "),s("h2",{attrs:{id:"长轮询-long-polling"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#长轮询-long-polling"}},[t._v("#")]),t._v(" 长轮询 long polling")]),t._v(" "),s("p",[t._v("长轮询解决了短轮询的问题，让每次请求都有意义。")]),t._v(" "),s("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://penguinbucket.obs.cn-southwest-2.myhuaweicloud.com/img/image-20220606164755838.png",alt:"image-20220606164755838"}}),t._v(" "),s("p",[t._v("但长轮询仍然存在问题：")]),t._v(" "),s("ul",[s("li",[t._v("客户端长时间收不到响应会导致超时，从而主动断开和服务器的连接\n"),s("ul",[s("li",[t._v("这种情况是可以处理的，但ajax请求因为超时而结束时，立即重新发送请求到服务器，虽然这种做法会让之前的请求变得无意义，但毕竟比短轮询好多了")])])]),t._v(" "),s("li",[t._v("由于客户端可能「过早的」请求了服务器，服务器不得不挂起这个请求直到新消息的出现。这会让服务器长时间的占用资源却没什么实际的事情可做")])]),t._v(" "),s("h2",{attrs:{id:"websocket-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#websocket-2"}},[t._v("#")]),t._v(" WebSocket")]),t._v(" "),s("p",[t._v("伴随着HTML5出现的WebSocket，从"),s("strong",[t._v("协议")]),t._v("上赋予了服务器主动推送消息的能力。")]),t._v(" "),s("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://penguinbucket.obs.cn-southwest-2.myhuaweicloud.com/img/image-20220606165005672.png",alt:"image-20220606165005672"}}),t._v(" "),s("p",[t._v("从上图可以看出：")]),t._v(" "),s("ul",[s("li",[t._v("WebSocket也是建立在TCP协议之上的，利用的是TCP全双工通信的能力")]),t._v(" "),s("li",[t._v("使用WebSocket，会经历两个阶段：握手阶段、通信阶段")])]),t._v(" "),s("p",[t._v("虽然优于轮询方案，但WebSocket仍然是有缺点的：")]),t._v(" "),s("ul",[s("li",[t._v("兼容性")]),t._v(" "),s("li",[t._v("WebSocket是HTML5新增的内容，因此古董版本的浏览器并不支持")]),t._v(" "),s("li",[t._v("维持TCP连接需要耗费资源\n"),s("ul",[s("li",[t._v("对于那些消息量少的场景，维持TCP连接确实会造成资源的浪费")])])])]),t._v(" "),s("blockquote",[s("p",[t._v("为了充分利用TCP连接的资源，在使用了WebSocket的页面，可以放弃ajax，都用WebSocket进行通信，当然这会带来程序设计上的一些问题，需要权衡。")])]),t._v(" "),s("h3",{attrs:{id:"握手"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#握手"}},[t._v("#")]),t._v(" 握手")]),t._v(" "),s("p",[t._v("WebSocket协议是一个高扩展性的协议，详细内容会比较复杂，这里仅讲解面试中会问到的握手协议。")]),t._v(" "),s("p",[t._v("当客户端需要和服务器使用WebSocket进行通信时，首先会使用"),s("strong",[t._v("HTTP协议")]),t._v("完成一次特殊的请求-响应，这一次请求-响应就是"),s("strong",[t._v("WebSocket握手")]),t._v("。")]),t._v(" "),s("p",[t._v("在握手阶段，首先由客户端向服务器发送一个请求，请求地址格式如下：")]),t._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 使用HTTP")]),t._v("\nws://mysite.com/path\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 使用HTTPS")]),t._v("\nwss://mysite.com/path\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("p",[t._v("请求头如下：")]),t._v(" "),s("div",{staticClass:"language-css line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-css"}},[s("code",[s("span",{pre:!0,attrs:{class:"token property"}},[t._v("Connection")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Upgrade "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 嘿，后续咱们别用HTTP了，升级吧 */")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("Upgrade")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" websocket "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 我们把后续的协议升级为websocket */")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("Sec-WebSocket-Version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 13 "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* websocket协议版本就用13好吗？ */")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("Sec-WebSocket-Key")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" YWJzZmFkZmFzZmRhYw== "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 暗号：天王盖地虎 */")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("p",[t._v("服务器如果同意，就应该响应下面的消息：")]),t._v(" "),s("div",{staticClass:"language-css line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-css"}},[s("code",[t._v("HTTP/1.1 101 Switching Protocols "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 换，马上换协议 */")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("Connection")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Upgrade "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 协议升级了 */")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("Upgrade")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" websocket "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 升级到websocket */")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("Sec-WebSocket-Accept")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ZzIzMzQ1Z2V3NDUyMzIzNGVy "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 暗号：小鸡炖蘑菇 */")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("p",[s("strong",[t._v("握手完成，后续消息收发不再使用HTTP，任何一方都可以主动发消息给对方")])]),t._v(" "),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),s("p",[t._v("WebSocket是HTML5新增的协议，它利用HTTP协议完成握手，然后通过TCP连接通道发送消息，使用WebSocket协议能够实现服务器主动发送消息。")]),t._v(" "),s("p",[t._v("客户端和服务端要使用WebSocket进行通信时，首先需要客户端向服务器发送一个HTTP请求以进行WebSocket握手，请求行中的 path 需要使用"),s("code",[t._v("ws:")]),t._v("开头的地址，请求头中要分别加入"),s("code",[t._v("upgrade")]),t._v("、"),s("code",[t._v("connection")]),t._v("、"),s("code",[t._v("Sec-WebSocket-Key")]),t._v("、"),s("code",[t._v("Sec-WebSocket-Version")]),t._v("标记。")]),t._v(" "),s("p",[t._v("然后，服务器收到请求后，发现这是一个WebSocket协议的握手请求，于是在响应行中添加"),s("code",[t._v("Switching Protocols")]),t._v("，同时在响应头中添加"),s("code",[t._v("upgrade")]),t._v("、"),s("code",[t._v("connection")]),t._v("、"),s("code",[t._v("Sec-WebSocket-Accept")]),t._v("标记。")]),t._v(" "),s("p",[t._v("最后，当客户端收到响应后即可完成握手，随后使用建立的TCP连接直接发送和接收消息。")]),t._v(" "),s("Vssue",{attrs:{options:{labels:[t.$page.relativePath.split("/")[0]]},title:t.$page.relativePath.split("/")[1]}})],1)}),[],!1,null,null,null);e.default=n.exports}}]);